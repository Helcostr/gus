<!DOCTYPE html>
<html>
  <head>
    <title>GUS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <style>
      body {
        text-align: center
      }

      body #searchForm, body #results {
        display: none;
      }

      body[data-state=form] #searchForm {
        display: inline-block;
        max-width: 750px;
      }

      body[data-state=results] #results {
        display: inline-block;
        max-width: 750px;
      }

      section {
        text-align: left;
        padding: 0.5em;
        border: 2px solid #000;
      }
      .note {
        color: red;
      }
    </style>
  </head>
  <body onload="init()">
    <h1>GUS</h1>
    <div id="searchForm">
      <form>
        <section>
          <h3>Search Term</h3>
          <input id="searchTerm" placeholder="Search for..."><br>
          <h4>Search in...</h4>
          <label><input type="checkbox" id="searchTitle" checked> Guild Title</label><br>
          <label><input type="checkbox" id="searchSummary" checked> Guild Summary</label>
          <p>Guild Description cannot be searched.</p>
          <label><input type="checkbox" id="useSearchTerm"> Don't use a search term</label><br>
          <p class="note">Note: When putting in multiple search terms, adhere to the following rules:<br>If all search terms must be in the guild, use "<i>search term</i> && <i>search term</i>". If either search term can be found in the guild, use "<i>search term</i> || <i>search term</i>". If you use both, you will have problems with the results.</p>
        </section>
        <section>
          <h3>Language</h3>
          <select id="langSelect">
            <option value="none">Loading Languages...</option>
          </select>
          <label><input type="checkbox" id="containsMyLanguage"> Must contain my language</label>
        </section>
        <section>
          <h3>Category</h3>
          <label>Main category:
            <select id="mainCategory" onchange='setSubCategories()'>
              <option value="none">Loading Categories...</option>
            </select>
          </label><br>
          <label>Sub Category:
            <select id="subCategory">
              <option value="none">Please pick a Main Category</option>
            </select>
          </label><br>
          <label><input type="checkbox" id="habiticaOfficial"> Must be Habitica Offical</label>
        </section>
      </form>
      <br>
      <br>
      <button onclick="searchGuilds()">Search Guilds</button>
    </div>
    <div id="results">
      <h2>Search Results</h2>
      <div id="resultsEndLocation">

      </div>
    </div>
    <script>
      var initState = "form";
      var lang = "en - English";
      var translationFile = "lang" + lang[0].toUpperCase() + lang[1] + ".json";
      var categories = {};
      var guilds = {};
      var languages = [];
      var formInput = {};
      var results = {};
      function E(id) {
        if (document.getElementById(id).type != 'checkbox') return document.getElementById(id).value;
        if (document.getElementById(id).type == 'checkbox') return document.getElementById(id).checked;
      }
      function setPageState(state) {
        document.getElementsByTagName("BODY")[0].setAttribute("data-state", state);
      }
      function getFormInput() {
        formInput = {
          searchTerm: E("searchTerm"),
          searchTitle: E("searchTitle"),
          searchSummary: E("searchSummary"),
          useSearchTerm: !(E("useSearchTerm")),
          lang: E("langSelect"),
          containsMyLanguage: E("containsMyLanguage"),
          mainCategory: E("mainCategory"),
          subCategory: E("subCategory"),
          habiticaOfficial: E("habiticaOfficial")
        };
      }
      function searchGuilds() {
        getFormInput();
        for (var key in guilds) {
          if (((guilds[key].title.search(formInput.searchTerm) != -1) || (guilds[key].summary.search(formInput.searchTerm) != -1) || formInput.useSearchTerm == false) && //Search Term
          ((formInput.lang == "none" || guilds[key].lang.indexOf(formInput.lang) != -1) && ((guilds[key].lang.indexOf(lang) != -1 && formInput.containsMyLanguage) || formInput.containsMyLanguage == false)) && //Language
          (formInput.mainCategory == "none" || guilds[key].category == formInput.mainCategory) && //Main Category
          (formInput.subCategory == "none" || guilds[key].sub == formInput.subCategory)) { //Sub Category
            results[key] = guilds[key];
          }
        }
        document.getElementById("resultsEndLocation").innerText = JSON.stringify(results);
        setPageState("results");
      }
      function getLanguages() {
        var languagesHTML = "<option value='none'>Don't filter by Specific Language</option>";
        for (var guild in guilds) {
          for (var language in guilds[guild].lang) {
            if (languages.indexOf(guilds[guild].lang[language]) == -1) {
              languages.push(guilds[guild].lang[language]);
              if (translationFile.languages[guilds[guild].lang[language].slice(0,2)]) {
                languagesHTML += "<option value='" + guilds[guild].lang[language] + "'>" + translationFile.languages[guilds[guild].lang[language].slice(0,2)] + "</option>";
              } else {
                languagesHTML += "<option value='" + guilds[guild].lang[language] + "'>" + guilds[guild].lang[language].slice(5) + "</option>";
              }
            }
          }
        }
        document.getElementById("langSelect").innerHTML = languagesHTML;
      }
      function getGuilds(location = "./output/gus.json") {
        function setGuilds(data) {
          guilds = data.guild;
          getLanguages();
        }
        $.ajax({
          dataType: "json",
          url: location,
          method: 'get',
          success: function(response) {
            setGuilds(response);
          }
        });
      }
      function getCategories() {
        function setCategories(data) {
          translationFile = data;
          categories = data.categories;
          setMainCategories();
        }
        var location = "./translation/" + translationFile;
        $.ajax({
          dataType: "json",
          url: location,
          method: 'get',
          success: function(response) {
            setCategories(response);
          }
        });
      }
      function setMainCategories() {
        var categoriesHTML = "<option value='none'>Don't filter by Category</option>";
        for (var key in categories) {
          categoriesHTML += "<option value='" + key + "'>" + categories[key][0] + "</option>";
        }
        document.getElementById("mainCategory").innerHTML = categoriesHTML;
      }
      function setSubCategories() {
        var mainCategory = document.getElementById("mainCategory").value;
        if (mainCategory == "none") {
          document.getElementById('subCategory').innerHTML = '<option value="none">Please pick a Main Category</option>';
        } else {
          var categoriesHTML = "<option value='none'>Don't filter by Subcategory</option>";
          for (var key in categories[mainCategory][1]) {
            categoriesHTML += "<option value='" + key + "'>" + categories[mainCategory][1][key] + "</option>";
          }
          document.getElementById('subCategory').innerHTML = categoriesHTML;
        }
      }
      function init() {
        getGuilds();
        getCategories();
        setPageState(initState);
      }
    </script>
  </body>
</html>